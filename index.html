<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã€V9.0ã€‘å°å—åœŸåœ°é–‹ç™¼è²¡å‹™æ±ºç­–ç³»çµ±ï½œå¯¦å‹™ä¿®æ­£ç‰ˆ</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-dark: #2C3E50;
            --primary-gold: #C5A065;
            --primary-light: #EBF5FB;
            --accent-red: #E74C3C;
            --accent-green: #27AE60;
            --bg-body: #F7F9FA;
            --bg-card: #FFFFFF;
            --border: #E1E4E8;
            --shadow: 0 4px 20px rgba(0,0,0,0.05);
        }

        * { box-sizing: border-box; outline: none; }
        body { font-family: 'Noto Sans TC', sans-serif; background-color: var(--bg-body); color: #333; margin: 0; padding: 30px; line-height: 1.6; font-size: 15px; }

        /* Layout */
        .container { max-width: 1280px; margin: 0 auto; display: grid; grid-template-columns: 1fr; gap: 30px; }
        @media(min-width: 1024px) { .container { grid-template-columns: 380px 1fr; } }

        /* Header */
        .header { text-align: center; margin-bottom: 40px; }
        .logo-group img { height: 60px; margin: 0 12px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1)); }
        .header h1 { color: var(--primary-dark); font-size: 2rem; font-weight: 800; margin: 15px 0 5px; letter-spacing: 1px; }
        .header .subtitle { color: #7F8C8D; font-size: 1rem; font-weight: 500; }

        /* Cards */
        .card { 
            background: var(--bg-card); 
            border-radius: 16px; 
            padding: 25px; 
            box-shadow: var(--shadow); 
            border: 1px solid #FFF;
            transition: transform 0.2s ease;
            margin-bottom: 25px;
        }
        .card:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.08); }
        
        .card-header { 
            font-size: 1.1rem; font-weight: 700; color: var(--primary-dark); 
            padding-bottom: 15px; margin-bottom: 20px; 
            border-bottom: 2px solid var(--primary-light);
            display: flex; justify-content: space-between; align-items: center;
        }

        /* Inputs */
        .input-group { margin-bottom: 15px; }
        .input-row { display: flex; gap: 15px; margin-bottom: 15px; align-items: flex-end; }
        .input-col { flex: 1; }
        .label { display: block; font-size: 0.9rem; font-weight: 600; color: #555; margin-bottom: 6px; }
        
        .input { 
            width: 100%; padding: 10px 15px; 
            border: 1px solid #DDD; border-radius: 8px; 
            text-align: right; font-size: 1rem; font-family: 'Consolas', monospace;
            background: #FAFAFA; transition: 0.2s; 
        }
        .input:focus { border-color: var(--primary-gold); background: #FFF; box-shadow: 0 0 0 3px rgba(197, 160, 101, 0.15); }
        .input-readonly { background: #F2F4F6; color: #7F8C8D; cursor: default; border-color: transparent; }
        select.input { text-align: left; cursor: pointer; }

        /* Highlight Input (Editable Sales Area) */
        .input-highlight {
            border: 2px solid var(--primary-gold); background: #FFFBF0; color: var(--primary-dark); font-weight: bold; font-size: 1.2rem;
        }

        /* Feedback Text */
        .calc-feedback { font-size: 0.8rem; color: var(--primary-gold); font-weight: 600; text-align: right; margin-top: 4px; }
        .hint-text { font-size: 0.8rem; color: #95A5A6; margin-top: 5px; line-height: 1.4; }

        /* Buttons */
        .btn-action { 
            background: transparent; border: 1px solid var(--primary-dark); color: var(--primary-dark); 
            padding: 4px 10px; border-radius: 6px; cursor: pointer; font-size: 0.8rem; font-weight: 600; 
            transition: 0.2s;
        }
        .btn-action:hover { background: var(--primary-dark); color: white; }
        
        .btn-print { 
            background: linear-gradient(135deg, var(--primary-dark) 0%, #34495E 100%); 
            color: white; width: 100%; padding: 15px; border: none; border-radius: 8px; 
            font-weight: bold; font-size: 1rem; cursor: pointer; margin-top: 10px; 
            box-shadow: 0 4px 15px rgba(44, 62, 80, 0.2); transition: 0.3s;
        }
        .btn-print:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(44, 62, 80, 0.3); }

        /* Tables */
        .table-box { border: 1px solid var(--border); border-radius: 10px; overflow: hidden; margin-bottom: 25px; }
        .table-header { background: var(--primary-light); padding: 12px 20px; font-weight: 700; color: var(--primary-dark); border-bottom: 1px solid var(--border); }
        .data-table { width: 100%; border-collapse: collapse; font-size: 0.95rem; }
        .data-table th, .data-table td { padding: 12px 20px; border-bottom: 1px solid #EEE; }
        .data-table th { text-align: left; color: #666; font-weight: 500; width: 50%; background: #FCFCFC; }
        .data-table td { text-align: right; font-family: 'Consolas', monospace; color: #2C3E50; font-weight: 600; }
        
        .row-total { background: #FEF9E7; }
        .row-total th { color: #D35400; }
        .row-total td { color: #D35400; font-size: 1.1rem; }
        
        .row-profit { background: #E8F8F5; }
        .row-profit th { color: var(--accent-green); }
        .row-profit td { color: var(--accent-green); font-size: 1.2rem; }

        .val-neg { color: var(--accent-red); }

        /* KPI Dashboard */
        .kpi-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 25px; }
        .kpi-card { background: #FFF; border: 1px solid var(--border); border-radius: 10px; padding: 15px; text-align: center; }
        .kpi-card.highlight { background: linear-gradient(135deg, var(--primary-dark), #34495E); color: white; border: none; }
        .kpi-card.gold { background: linear-gradient(135deg, var(--primary-gold), #D4AC0D); color: white; border: none; }
        .kpi-label { font-size: 0.8rem; opacity: 0.9; margin-bottom: 5px; }
        .kpi-val { font-size: 1.4rem; font-weight: 700; }

        /* Tabs */
        .tab-group { display: flex; border-bottom: 2px solid var(--border); margin-bottom: 25px; }
        .tab { padding: 12px 20px; cursor: pointer; font-size: 1rem; color: #95A5A6; font-weight: 600; border-bottom: 3px solid transparent; transition: 0.3s; }
        .tab.active { color: var(--primary-dark); border-bottom-color: var(--primary-dark); }
        
        .section-box { display: none; animation: fadeIn 0.3s ease; }
        .section-box.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        @media print {
            body { background: white; padding: 0; }
            .btn-print, .btn-action, .internal-badge { display: none; }
            .card { box-shadow: none; border: 1px solid #000; break-inside: avoid; }
            .section-box { display: block !important; }
            .tab-group { display: none; }
        }
    </style>
</head>
<body>

<div class="header">
    <div class="logo-group">
        <img src="å®åœ‹åœ°æ”¿å°é¢.jpg">
        <img src="æ˜“ä¸logo-01.jpg">
    </div>
    <h1>å°å—åœŸåœ°é–‹ç™¼è²¡å‹™æ±ºç­–ç³»çµ±</h1>
    <div class="subtitle">V9.0 å¯¦å‹™ä¿®æ­£ç‰ˆï½œå¯éŠ·å”®é¢ç©æ‰‹å‹•æ ¡æ­£ï½œè²¡å‹™ç²¾ç®—</div>
</div>

<div class="container">
    
    <div class="left-panel">
        
        <div class="card" style="border-left: 5px solid var(--primary-gold);">
            <div class="card-header">
                1. åŸºåœ°æ¢ä»¶èˆ‡é¢ç©è©¦ç®—
                <button class="btn-action" onclick="resetDefault()">é‡ç½®</button>
            </div>
            
            <div class="input-row">
                <div class="input-col">
                    <label class="label">åœŸåœ°é¢ç© (mÂ²)</label>
                    <input type="number" id="inSqm" class="input" value="172" oninput="calcBase()">
                </div>
                <div class="input-col">
                    <label class="label">æ›ç®—åªæ•¸</label>
                    <input type="text" id="outPing" class="input input-readonly" readonly>
                </div>
            </div>

            <div class="input-group">
                <label class="label">é–‹ç™¼æ¨¡å¼</label>
                <select id="inType" class="input" onchange="toggleMode(); calcBase();">
                    <option value="tou-tian">é€å¤© (ä¾å»ºè”½ç‡èˆ‡æ¨“å±¤)</option>
                    <option value="da-lou">å¤§æ¨“ (ä¾å®¹ç©ç‡)</option>
                </select>
            </div>

            <div class="input-row">
                <div class="input-col">
                    <label class="label">æ³•å®šå»ºè”½ç‡ (%)</label>
                    <input type="number" id="inBCR" class="input" value="50" oninput="calcBase()">
                </div>
                <div class="input-col">
                    <label class="label">ç¸½æ ¸å®šå®¹ç© (%)</label>
                    <input type="number" id="inTotalVol" class="input" value="180" oninput="calcBase()">
                </div>
            </div>

            <div style="background:#FFF9C4; padding:15px; border-radius:8px; border:1px dashed var(--primary-gold); margin-top:15px;">
                <div class="input-group">
                    <label class="label" style="color:#D35400;">â˜… å¯¦éš›å¯éŠ·å”®ç¸½é¢ç© (åª)</label>
                    <input type="number" id="inRealSaleArea" class="input input-highlight" value="0" oninput="calcFinance()">
                    <div class="calc-feedback" id="fbEfficiency">åªæ•ˆä¿‚æ•¸ï¼š0.00 å€</div>
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span id="txtEstArea" style="font-size:0.85rem; color:#666;">ç³»çµ±ä¼°ç®—å€¼ï¼š0 åª</span>
                    <button class="btn-action" onclick="useEstimate()">å¸¶å…¥ä¼°ç®—å€¼</button>
                </div>
                <p class="hint-text">
                    *ç³»çµ±ä¼°ç®—åƒ…ä¾›åƒè€ƒã€‚é€å¤©å—é™æ–¼æ¨“æ¢¯é–“ã€è»Šä½é…ç½®èˆ‡æ³•è¦ä¸Šé™ï¼Œè«‹ä¾å»ºç¯‰å¸«æª¢è¨åœ–é¢ç‚ºæº–ï¼Œå¯ç›´æ¥ä¿®æ”¹ä¸Šæ–¹æ•¸å­—ã€‚
                </p>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                2. ç‡Ÿæ”¶æˆæœ¬
                <button class="btn-action" onclick="autoCost()">å¸¶å…¥å…¬å ±</button>
            </div>
            <div class="input-row">
                <div class="input-col">
                    <label class="label">å¹³å‡æˆ¿åƒ¹ (è¬/åª)</label>
                    <input type="number" id="inPrice" class="input" value="32" oninput="calcFinance()">
                </div>
                <div class="input-col">
                    <label class="label">è»Šä½ç¸½éŠ· (è¬)</label>
                    <input type="number" id="inParkingSales" class="input" value="0" oninput="calcFinance()">
                </div>
            </div>
            <div class="input-row">
                <div class="input-col">
                    <label class="label">åœŸåœ°æˆæœ¬ (è¬/åª)</label>
                    <input type="number" id="inLandCost" class="input" value="40" oninput="calcFinance()">
                </div>
            </div>
            <div class="input-row">
                <div class="input-col">
                    <label class="label">ç‡Ÿé€ å–®åƒ¹ (è¬/åª)</label>
                    <input type="number" id="inConstCost" class="input" value="10.5" oninput="calcFinance()">
                </div>
                <div class="input-col">
                    <label class="label">ç®¡éŠ·è²»ç‡ (%)</label>
                    <input type="number" id="inOverhead" class="input" value="14" oninput="calcFinance()">
                </div>
            </div>
        </div>

        <div class="card" style="border-left: 5px solid #3498DB;">
            <div class="card-header">3. åœŸå»ºèè³‡</div>
            <div class="input-row">
                <div class="input-col">
                    <label class="label">åœŸè (è¬)</label>
                    <input type="number" id="inLandLoan" class="input" value="1500" oninput="calcFinance()">
                </div>
                <div class="input-col">
                    <label class="label">åˆ©ç‡ (%)</label>
                    <input type="number" id="inLandRate" class="input" value="2.5" step="0.1" oninput="calcFinance()">
                </div>
            </div>
            <div class="input-row">
                <div class="input-col">
                    <label class="label">å»ºè (è¬)</label>
                    <input type="number" id="inConstLoan" class="input" value="800" oninput="calcFinance()">
                </div>
                <div class="input-col">
                    <label class="label">åˆ©ç‡ (%)</label>
                    <input type="number" id="inConstRate" class="input" value="2.8" step="0.1" oninput="calcFinance()">
                </div>
            </div>
            <div class="input-row">
                <div class="input-col">
                    <label class="label">å€Ÿæ¬¾å¹´æœŸ</label>
                    <input type="number" id="inLoanYears" class="input" value="2" step="0.5" oninput="calcFinance()">
                </div>
                <div class="input-col">
                    <label class="label">é‚„æ¬¾æ–¹å¼</label>
                    <select id="inRepayMethod" class="input" onchange="calcFinance()">
                        <option value="interest_only">åƒ…æŒ‰æœˆç¹³æ¯</option>
                        <option value="pmt">æœ¬æ¯æ”¤é‚„</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="card" style="border-left: 5px solid var(--accent-red);">
            <div class="card-header">4. ç¨…å‹™ (æˆ¿åœ°åˆä¸€ 2.0)</div>
            <div class="input-row">
                <div class="input-col">
                    <label class="label">åœŸåœ°æ¼²åƒ¹æ•¸é¡</label>
                    <input type="number" id="inLandIncBase" class="input" value="0" oninput="calcFinance()">
                </div>
                <div class="input-col">
                    <label class="label">é ä¼°åœŸå¢ç¨…</label>
                    <input type="number" id="inLandTax" class="input" value="0" oninput="calcFinance()">
                </div>
            </div>
        </div>

        <button class="btn-print" onclick="window.print()">ğŸ–¨ï¸ åˆ—å°å ±è¡¨ / å­˜æˆ PDF</button>
    </div>

    <div class="right-panel">
        
        <div class="tab-group">
            <div class="tab active" onclick="switchTab('tab1')">A. è²¡å‹™æç›Šè¡¨</div>
            <div class="tab" onclick="switchTab('tab2')">B. é¢ç©è¨ˆç®—é©—è­‰</div>
        </div>

        <div id="tab1" class="section-box active">
            
            <div class="kpi-row">
                <div class="kpi-card highlight">
                    <div class="kpi-label">é ä¼°ç¸½éŠ·é‡‘é¡</div>
                    <div class="kpi-val" id="kpiSales">0</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">å…¨æ¡ˆç¸½æˆæœ¬</div>
                    <div class="kpi-val" id="kpiTotalCost">0</div>
                </div>
                <div class="kpi-card gold">
                    <div class="kpi-label">è‡ªæœ‰è³‡é‡‘å›å ±ç‡ (ROE)</div>
                    <div class="kpi-val" id="kpiROE">0%</div>
                </div>
            </div>

            <div class="table-box">
                <div class="table-header">å°ˆæ¡ˆæç›Šé ä¼° (Income Statement)</div>
                <table class="data-table">
                    <tr>
                        <th>(+) æˆ¿åœ°ç¸½éŠ·é‡‘é¡ <span class="hint-text">(ä¾è¼¸å…¥ä¹‹éŠ·å”®é¢ç©è¨ˆç®—)</span></th>
                        <td id="tSales">0</td>
                    </tr>
                    <tr>
                        <th style="padding-left:20px;">- åœŸåœ°æˆæœ¬</th>
                        <td id="tLandCost">0</td>
                    </tr>
                    <tr>
                        <th style="padding-left:20px;">- ç‡Ÿå»ºæ–½å·¥è²»</th>
                        <td id="tConstCost">0</td>
                    </tr>
                    <tr>
                        <th style="padding-left:20px;">- ç®¡éŠ·è²»ç”¨</th>
                        <td id="tOverhead">0</td>
                    </tr>
                    <tr>
                        <th style="padding-left:20px;">- èè³‡åˆ©æ¯ <span class="val-neg" style="font-size:0.8rem">(å»ºèå‹•ç”¨60%)</span></th>
                        <td id="tInterest" style="color:#C0392B">0</td>
                    </tr>
                    <tr class="row-total">
                        <th>(=) ç¨…å‰æ·¨åˆ© (EBIT)</th>
                        <td id="tPreTax">0</td>
                    </tr>
                    <tr>
                        <th>(-) ç¨…è²  (åœŸå¢+æˆ¿åœ°åˆä¸€)</th>
                        <td class="val-neg" id="tTax">0</td>
                    </tr>
                    <tr class="row-profit">
                        <th>(=) ç¨…å¾Œæ·¨åˆ©</th>
                        <td id="tNetProfit">0</td>
                    </tr>
                </table>
            </div>
        </div>

        <div id="tab2" class="section-box">
            <div class="table-box">
                <div class="table-header">ç³»çµ±ä¼°ç®—é‚è¼¯é©—è­‰</div>
                <table class="data-table">
                    <tr>
                        <th>åŸºåœ°é¢ç©</th>
                        <td id="vLandArea">0 åª</td>
                    </tr>
                    <tr>
                        <th>æ³•å®šç¸½æ¨“åœ°æ¿ (å®¹ç©ä¸Šé™)</th>
                        <td id="vLegalMax">0 åª</td>
                    </tr>
                    <tr>
                        <th>(+) å…è¨ˆå®¹ç©ä¼°ç®— (é™½å°/å±‹çª)</th>
                        <td id="vAddOn">0 åª</td>
                    </tr>
                    <tr style="background:#F2F4F6">
                        <th>(=) ç³»çµ±å»ºè­°éŠ·å”®åªæ•¸</th>
                        <td id="vSysEst">0 åª</td>
                    </tr>
                    <tr class="row-total" style="border-top:2px solid #F39C12">
                        <th>(â˜…) æ‚¨è¨­å®šçš„å¯¦éš›éŠ·åª</th>
                        <td id="vUserSet">0 åª</td>
                    </tr>
                </table>
                <div style="padding:15px; font-size:0.9rem; color:#666;">
                    <strong>ğŸ’¡ ä¿®æ­£èªªæ˜ï¼š</strong><br>
                    1. <strong>é€å¤©ï¼š</strong>å…è¨ˆå®¹ç©æœ‰æ³•è¦ä¸Šé™ã€‚é™½å°é€šå¸¸ä¸è¶…éè©²å±¤10%æˆ–8mÂ²ï¼›å±‹çªé¢ç©é€šå¸¸ç‚ºå»ºç¯‰é¢ç©1/8ã€‚<br>
                    2. <strong>ç³»çµ±ä¿‚æ•¸ä¸‹ä¿®ï¼š</strong>é‡å°é€å¤©æ¡ˆï¼Œç³»çµ±é è¨­æ¡ç”¨ <strong>1.35~1.40</strong> å€ä¿‚æ•¸ä¼°ç®—ï¼ˆåŸç‚º1.6ï¼‰ï¼Œæ›´è²¼è¿‘å¯¦å‹™ã€‚<br>
                    3. <strong>æº–ç¢ºæ€§ï¼š</strong>è«‹ç›´æ¥æ–¼å·¦å´é»ƒè‰²æ¬„ä½è¼¸å…¥æ‚¨çš„ã€Œå»ºç…§/æ¬Šç‹€åªæ•¸ã€ï¼Œå³å´å ±è¡¨å°‡ä»¥æ­¤ç‚ºæº–ã€‚
                </div>
            </div>
        </div>

    </div>
</div>

<script>
    // --- åƒæ•¸ ---
    const SQM_TO_PING = 0.3025;
    // å°å—å…¬å ±åƒè€ƒ (éŠ·å”®å»ºåªé€ åƒ¹)
    const COST_DB = { 'tou-tian': 10.5, 'da-lou': 14.5 };

    // --- DOM Elements ---
    const ui = {
        sqm: document.getElementById('inSqm'),
        ping: document.getElementById('outPing'),
        type: document.getElementById('inType'),
        bcr: document.getElementById('inBCR'),
        vol: document.getElementById('inTotalVol'),
        
        // æ ¸å¿ƒä¿®æ­£ï¼šéŠ·å”®é¢ç©è¼¸å…¥
        realSaleArea: document.getElementById('inRealSaleArea'),
        fbEfficiency: document.getElementById('fbEfficiency'),
        txtEstArea: document.getElementById('txtEstArea'),
        
        price: document.getElementById('inPrice'),
        parkingSales: document.getElementById('inParkingSales'),
        landCost: document.getElementById('inLandCost'),
        constCost: document.getElementById('inConstCost'),
        overhead: document.getElementById('inOverhead'),

        landLoan: document.getElementById('inLandLoan'),
        landRate: document.getElementById('inLandRate'),
        constLoan: document.getElementById('inConstLoan'),
        constRate: document.getElementById('inConstRate'),
        loanYears: document.getElementById('inLoanYears'),
        repayMethod: document.getElementById('inRepayMethod'),

        landIncBase: document.getElementById('inLandIncBase'),
        landTax: document.getElementById('inLandTax'),

        // Outputs
        kpiSales: document.getElementById('kpiSales'),
        kpiTotalCost: document.getElementById('kpiTotalCost'),
        kpiROE: document.getElementById('kpiROE'),

        tSales: document.getElementById('tSales'),
        tLandCost: document.getElementById('tLandCost'),
        tConstCost: document.getElementById('tConstCost'),
        tOverhead: document.getElementById('tOverhead'),
        tInterest: document.getElementById('tInterest'),
        tPreTax: document.getElementById('tPreTax'),
        tTax: document.getElementById('tTax'),
        tNetProfit: document.getElementById('tNetProfit'),

        // Verification Tab
        vLandArea: document.getElementById('vLandArea'),
        vLegalMax: document.getElementById('vLegalMax'),
        vAddOn: document.getElementById('vAddOn'),
        vSysEst: document.getElementById('vSysEst'),
        vUserSet: document.getElementById('vUserSet')
    };

    let sysEstimatedArea = 0;

    function format(num) { return Math.round(num).toLocaleString(); }

    function switchTab(tabId) {
        document.querySelectorAll('.section-box').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        event.currentTarget.classList.add('active');
    }

    function toggleMode() {
        // åˆ‡æ›æ¨¡å¼æ™‚é‡æ–°ä¼°ç®—
        calcBase();
    }

    function autoCost() {
        if(COST_DB[ui.type.value]) {
            ui.constCost.value = COST_DB[ui.type.value];
            calcFinance();
        }
    }

    function resetDefault() {
        ui.sqm.value = 172;
        ui.vol.value = 180;
        ui.bcr.value = 50;
        calcBase();
    }

    function useEstimate() {
        ui.realSaleArea.value = sysEstimatedArea.toFixed(2);
        calcFinance();
    }

    function calculateLoanInterest(principal, annualRate, years, method) {
        if (principal <= 0 || annualRate <= 0 || years <= 0) return 0;
        let rate = annualRate / 100;
        let monthlyRate = rate / 12;
        let months = Math.ceil(years * 12);
        let totalInterest = 0;

        if (method === 'interest_only') {
            totalInterest = principal * rate * years;
        } else {
            // æœ¬æ¯æ”¤é‚„ (PMT)
            let pmt = principal * (monthlyRate * Math.pow(1 + monthlyRate, months)) / (Math.pow(1 + monthlyRate, months) - 1);
            let totalPayment = pmt * months;
            totalInterest = totalPayment - principal;
        }
        return totalInterest;
    }

    // --- 1. åŸºç¤é¢ç©ä¼°ç®—é‚è¼¯ ---
    function calcBase() {
        let sqm = parseFloat(ui.sqm.value) || 0;
        let ping = sqm * SQM_TO_PING;
        ui.ping.value = ping.toFixed(2);

        let vol = parseFloat(ui.vol.value) / 100 || 0;
        let bcr = parseFloat(ui.bcr.value) / 100 || 0;
        let type = ui.type.value;

        // è¨ˆç®—å®¹ç©ä¸Šé™æ¨“åœ°æ¿ (Base FAR Area)
        let legalMaxArea = ping * vol;

        // ä¼°ç®—å…è¨ˆå®¹ç©åŠ é …
        let addOnArea = 0;
        let factor = 0;

        if (type === 'tou-tian') {
            // é€å¤©é‚è¼¯ä¿®æ­£ï¼šåƒè€ƒç”¨æˆ¶åé¥‹ (1.8å®¹ç© -> å¯¦éš›ä¸Šç´„ 1.36å€åœ°åª)
            // å‡è¨­æ³•å®šå®¹ç©å…§ + é™½å°(10%) + å±‹çª(æœ‰é™)
            // å¯¦å‹™ç¶“é©—ï¼šé€å¤©ä¿‚æ•¸ç´„åœ¨ 1.35 ~ 1.45 (å«æ¢¯é–“ã€é™½å°)
            // é€™è£¡æ¡ç”¨ 1.4 ä½œç‚ºé€å¤©é è¨­ä¼°ç®—ä¿‚æ•¸ï¼Œè‹¥å®¹ç©ç‡ä½(å¦‚180%)ï¼Œä¿‚æ•¸å¯èƒ½æ›´ä½
            
            // ä½¿ç”¨è€…æ¡ˆä¾‹ï¼š180% -> 1.36å€éŠ·åª (127/93.6 = 1.35)
            // ç³»çµ±ä¼°ç®—ï¼šBase * 1.1 (é™„å±¬) + å±‹çª(æ¯æ£Ÿç´„10-15åª)
            
            // é€™è£¡æ”¹ç”¨ç°¡å–®ä¿‚æ•¸æ³•ä¾›åƒè€ƒ
            factor = 1.36; // ä¾æ“šç”¨æˆ¶åé¥‹å¾®èª¿
            sysEstimatedArea = legalMaxArea * (factor / vol); // æ›ç®—å›ç›¸å°æ–¼åœ°åªçš„å€æ•¸? ä¸ï¼Œç›´æ¥ç”¨å®¹ç©é¢ç©å»¶ä¼¸
            
            // æ›´ç²¾ç¢ºï¼šæ³•å®šå®¹ç©é¢ç© * 1.15 (å«é™½å°å±‹çª)
            sysEstimatedArea = legalMaxArea * 1.15;
            
            // è‹¥ä¼°ç®—å‡ºä¾†çš„å–®å±¤é¢ç©è¶…éå»ºè”½ç‡ï¼Œéœ€checkï¼Œä½†æ­¤è™•åšæ¦‚ä¼°å³å¯
            addOnArea = sysEstimatedArea - legalMaxArea;

        } else {
            // å¤§æ¨“ï¼šå…¬è¨­æ¯”é«˜ï¼Œä¿‚æ•¸è¼ƒå¤§
            factor = 1.6;
            sysEstimatedArea = legalMaxArea * factor; // å«å¤§å…¬ã€å°å…¬ã€è»Šä½
            addOnArea = sysEstimatedArea - legalMaxArea;
        }

        // æ›´æ–° UI æç¤º
        ui.txtEstArea.innerText = `ç³»çµ±ä¼°ç®—å€¼ï¼š${sysEstimatedArea.toFixed(2)} åª`;
        
        // è‹¥ä½¿ç”¨è€…é‚„æ²’è¼¸å…¥éï¼Œé è¨­å¡«å…¥ä¼°ç®—å€¼ (ç¬¬ä¸€æ¬¡)
        // ä½†ç‚ºäº†è®“ä½¿ç”¨è€…æœ‰æ„Ÿï¼Œé€™è£¡ä¸è‡ªå‹•è¦†è“‹ï¼Œé™¤éå€¼ç‚º0
        if (parseFloat(ui.realSaleArea.value) === 0) {
            ui.realSaleArea.value = sysEstimatedArea.toFixed(2);
        }

        // Render Verification Tab
        ui.vLandArea.innerText = ping.toFixed(2) + " åª";
        ui.vLegalMax.innerText = legalMaxArea.toFixed(2) + " åª";
        ui.vAddOn.innerText = addOnArea.toFixed(2) + " åª";
        ui.vSysEst.innerText = sysEstimatedArea.toFixed(2) + " åª";

        calcFinance();
    }

    // --- 2. è²¡å‹™ç²¾ç®— (ä¾æ“šæ‰‹å‹•è¼¸å…¥çš„éŠ·åª) ---
    function calcFinance() {
        let saleArea = parseFloat(ui.realSaleArea.value) || 0;
        let ping = parseFloat(ui.ping.value) || 0;

        // Update Efficiency Feedback
        if(ping > 0) {
            let eff = saleArea / ping;
            ui.fbEfficiency.innerText = `åªæ•ˆä¿‚æ•¸ï¼š${eff.toFixed(2)} å€`;
            ui.vUserSet.innerText = saleArea.toFixed(2) + " åª";
        }

        // Revenue
        let price = parseFloat(ui.price.value) || 0;
        let parkingSales = parseFloat(ui.parkingSales.value) || 0;
        let totalSales = (saleArea * price) + parkingSales;

        // Direct Cost
        let landUnitPrice = parseFloat(ui.landCost.value) || 0;
        let totalLandCost = ping * landUnitPrice;

        let constUnitPrice = parseFloat(ui.constCost.value) || 0;
        let totalConstCost = saleArea * constUnitPrice; // ä¾éŠ·åªè¨ˆåƒ¹

        let overheadRate = (parseFloat(ui.overhead.value) || 0) / 100;
        let totalOverhead = totalSales * overheadRate;

        // Interest
        let lAmt = parseFloat(ui.landLoan.value) || 0;
        let lRate = (parseFloat(ui.landRate.value) || 0);
        let cAmt = parseFloat(ui.constLoan.value) || 0;
        let cRate = (parseFloat(ui.constRate.value) || 0);
        let years = parseFloat(ui.loanYears.value) || 0;
        let repayMethod = ui.repayMethod.value;

        let lInt = calculateLoanInterest(lAmt, lRate, years, repayMethod);
        // å»ºèå‹•ç”¨ç‡ 60%
        let cInt = calculateLoanInterest(cAmt, cRate, years, repayMethod) * 0.6;
        let totalInterest = lInt + cInt;

        // Profit
        let totalCost = totalLandCost + totalConstCost + totalOverhead + totalInterest;
        let preTax = totalSales - totalCost;

        // Tax
        let landInc = parseFloat(ui.landIncBase.value) || 0;
        let landTax = parseFloat(ui.landTax.value) || 0;
        let taxable = preTax - landInc;
        if(taxable < 0) taxable = 0;
        let houseTax = taxable * 0.2;
        let totalTax = landTax + houseTax;
        let netProfit = preTax - totalTax;

        // KPI
        let equity = totalCost - (lAmt + cAmt);
        let roe = (equity > 0) ? (netProfit / equity) * 100 : 0;

        // Render
        ui.kpiSales.innerText = format(totalSales);
        ui.kpiTotalCost.innerText = format(totalCost);
        ui.kpiROE.innerText = roe.toFixed(1) + "%";

        ui.tSales.innerText = format(totalSales);
        ui.tLandCost.innerText = format(totalLandCost);
        ui.tConstCost.innerText = format(totalConstCost);
        ui.tOverhead.innerText = format(totalOverhead);
        ui.tInterest.innerText = format(totalInterest);
        ui.tPreTax.innerText = format(preTax);
        ui.tTax.innerText = format(totalTax);
        ui.tNetProfit.innerText = format(netProfit);
    }

    // Init
    calcBase();
</script>

</body>
</html>